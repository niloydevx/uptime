<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mini Uptime Monitor</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    h1 { margin-top: 0; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    input, button, select { padding: 8px 10px; font-size: 14px; }
    table { border-collapse: collapse; width: 100%; margin-top: 16px; }
    th, td { border-bottom: 1px solid #eaeaea; padding: 10px; text-align: left; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; }
    .up { background:#e6ffed; color:#03663c; border:1px solid #b7f5c8; }
    .down { background:#ffefef; color:#8d1a1a; border:1px solid #ffd0d0; }
    .muted { color:#666 }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>
</head>
<body>
  <h1>Mini Uptime Monitor</h1>
  <div class="row">
    <input id="urls" size="70" placeholder="Comma-separated URLs (e.g. https://example.com, https://02799407-...choreoapps.dev)" />
    <select id="interval">
      <option value="5000">Every 5s</option>
      <option value="10000">10s</option>
      <option value="30000">30s</option>
      <option value="60000">1m</option>
    </select>
    <button id="addBtn">Add</button>
  </div>

  <table id="tbl">
    <thead>
      <tr>
        <th>URL</th>
        <th>Status</th>
        <th>Latency</th>
        <th>Uptime</th>
        <th>Checked</th>
        <th>Every</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>

  <script>
    const $ = s => document.querySelector(s);
    const rows = $("#rows");
    const fmt = ms => ms == null ? "—" : `${ms} ms`;
    const ago = ts => ts ? new Intl.RelativeTimeFormat(undefined, {numeric:"auto"})
                    .format(Math.round((ts - Date.now())/1000/60), "minutes") : "—";
    const every = ms => ms >= 60000 ? (ms/60000)+"m" : (ms/1000)+"s";

    async function fetchList() {
      const res = await fetch('/api/monitors');
      const data = await res.json();
      rows.innerHTML = data.map(m => `
        <tr>
          <td class="mono">${m.url}</td>
          <td>${m.lastStatus && m.lastStatus >=200 && m.lastStatus<400
              ? `<span class="badge up">UP (${m.lastStatus})</span>`
              : `<span class="badge down">${m.lastStatus ? 'DOWN ('+m.lastStatus+')':'DOWN'}</span>`}</td>
          <td>${fmt(m.lastLatency)}</td>
          <td>${m.uptimePct?.toFixed ? m.uptimePct.toFixed(1) : m.uptimePct}%</td>
          <td class="muted">${m.lastChecked ? new Date(m.lastChecked).toLocaleTimeString() : '—'}</td>
          <td>${every(m.intervalMs)}</td>
          <td>
            <button onclick="toggle('${m.id}', ${!m.enabled})">${m.enabled ? 'Disable' : 'Enable'}</button>
            <button onclick="removeMon('${m.id}')">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    async function toggle(id, enabled) {
      await fetch('/api/monitors/'+id, {
        method:'PATCH',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ enabled })
      });
      fetchList();
    }

    async function removeMon(id) {
      await fetch('/api/monitors/'+id, { method:'DELETE' });
      fetchList();
    }

    $("#addBtn").onclick = async () => {
      const urls = $("#urls").value.split(",").map(s => s.trim()).filter(Boolean);
      const intervalMs = Number($("#interval").value) || 5000;
      if (urls.length === 0) return;

      if (urls.length === 1) {
        await fetch('/api/monitors', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ url: urls[0], intervalMs })
        });
      } else {
        await fetch('/api/monitors/bulk', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ urls, intervalMs })
        });
      }
      $("#urls").value = '';
      fetchList();
    };

    fetchList();
    setInterval(fetchList, 3000);
  </script>
</body>
</html>
